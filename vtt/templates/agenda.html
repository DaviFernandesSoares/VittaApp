{% load static %}
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Painel Tutor - Agenda</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Minha Agenda</h3>
    <button id="createSeries" class="btn btn-primary">+ Nova série (semanal)</button>
  </div>
  <div id="calendar"></div>
</div>

<!-- Modal criar série -->
<div class="modal fade" id="seriesModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="seriesForm" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Criar série semanal</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="errors" class="alert alert-danger d-none"></div>
        <div class="mb-2">
          <label>Título</label>
          <input name="title" class="form-control">
        </div>
        <div class="mb-2">
          <label>Dia da semana</label>
          <select name="weekday" class="form-select">
            <option value="0">Segunda</option><option value="1">Terça</option><option value="2">Quarta</option>
            <option value="3">Quinta</option><option value="4">Sexta</option><option value="5">Sábado</option>
            <option value="6">Domingo</option>
          </select>
        </div>
        <div class="row">
          <div class="col">
            <label>Início (HH:MM)</label>
            <input name="start_time" type="time" class="form-control" required>
          </div>
          <div class="col">
            <label>Término (HH:MM)</label>
            <input name="end_time" type="time" class="form-control" required>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col">
            <label>Data início (opcional)</label>
            <input name="start_date" type="date" class="form-control">
          </div>
          <div class="col">
            <label>Data fim (opcional)</label>
            <input name="end_date" type="date" class="form-control">
          </div>
        </div>
        <div class="mt-2">
          <label>Capacidade</label>
          <input name="capacity" type="number" min="1" value="1" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Criar e gerar próximas 8 semanas</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const csrf = document.querySelector('meta[name=csrf-token]').getAttribute('content');
document.addEventListener('DOMContentLoaded', function(){
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    events: '{% url "api_slots" %}',
    headerToolbar: { left:'prev,next today', center:'title', right:'timeGridWeek,timeGridDay' },
    locale: 'pt-br',
  });
  calendar.render();

  const seriesModal = new bootstrap.Modal(document.getElementById('seriesModal'));
  document.getElementById('createSeries').addEventListener('click', ()=> {
    document.getElementById('seriesForm').reset();
    document.getElementById('errors').classList.add('d-none');
    seriesModal.show();
  });

  document.getElementById('seriesForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const form = new FormData(e.target);
    const res = await fetch('{% url "create_recurring" %}', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrf },
      body: form,
      credentials: 'same-origin'
    });
    const data = await res.json();
    if (res.ok && data.ok) {
      calendar.refetchEvents();
      seriesModal.hide();
      alert('Série criada e próximas ocorrências geradas');
    } else {
      const box = document.getElementById('errors');
      box.innerText = JSON.stringify(data.errors || data.error || 'Erro');
      box.classList.remove('d-none');
    }
  });
});
</script>
</body>
</html>